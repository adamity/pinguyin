<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Pinguyin - Minimalist Pinyin Writing Zone
    </title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'IBM Plex Mono', monospace;
        }

        .textarea {
            border: none !important;
            outline: none !important;
            resize: none !important;
        }
    </style>
</head>
<body class="bg-dark">
    <div class="container vh-100 overflow-hidden">
        <!-- Menu Bar -->
        <div class="d-flex justify-content-center fixed-top bg-dark">
            <button type="button" class="btn btn-sm rounded-pill btn-dark px-4 mx-2 text-white-50" data-bs-toggle="modal" data-bs-target="#helpModal">Help</button>
            <button type="button" class="btn btn-sm rounded-pill btn-dark px-4 mx-2 text-white-50" onclick="toggleFullscreen()">Fullscreen</button>
            <button type="button" class="btn btn-sm rounded-pill btn-dark px-4 mx-2 text-white-50" onclick="downloadTxt()">Download</button>
        </div>

        <textarea class="bg-transparent textarea border-0 shadow-none text-white w-100 h-100 py-5" placeholder="Write your pinyin here..." id="pinyinArea"></textarea>

        <!-- Bottom Bar -->
        <div class="d-flex justify-content-between fixed-bottom bg-dark">
            <p id="wordCounter" class="text-white-50 m-3">0 / 0</p>
            <a href="https://zulkiflizin.com" target="_blank" class="text-decoration-none text-white-50 m-3">üê± ConsistentCat</a>
        </div>
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-dark">
                <div class="modal-body">
                    <!-- Add Instruction Here -->
                    <h5 class="text-white">How to use Pinguyin?</h5>

                    <!-- 
                        1. Write your pinyin in the textarea.
                        2. The pinyin will be automatically converted to pinyin with tone.
                        3. You can download the pinyin as a text file.
                        4. Follow the rules below to write pinyin with tone.
                    -->
                    <p class="text-white">1. Write your pinyin in the textarea.</p>
                    <p class="text-white">2. The pinyin will be automatically converted to pinyin with tone.</p>
                    <p class="text-white">3. You can download the pinyin as a text file.</p>
                    <p class="text-white">4. Your pinyin will be saved locally in your browser.</p>
                    <p class="text-white">5. Follow the rules below to write pinyin with tone.</p>

                    <!-- Pinyin Tone Table from tone map -->
                    <table class="table table-dark table-striped table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">Pinyin</th>
                                <th scope="col">Tone</th>
                                <th scope="col">Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>a</td>
                                <td>1</td>
                                <td>ƒÅ</td>
                            </tr>
                            <tr>
                                <td>a</td>
                                <td>2</td>
                                <td>√°</td>
                            </tr>
                            <tr>
                                <td>a</td>
                                <td>3</td>
                                <td>«é</td>
                            </tr>
                            <tr>
                                <td>a</td>
                                <td>4</td>
                                <td>√†</td>
                            </tr>
                            <tr>
                                <td>e</td>
                                <td>1</td>
                                <td>ƒì</td>
                            </tr>
                            <tr>
                                <td>e</td>
                                <td>2</td>
                                <td>√©</td>
                            </tr>
                            <tr>
                                <td>e</td>
                                <td>3</td>
                                <td>ƒõ</td>
                            </tr>
                            <tr>
                                <td>e</td>
                                <td>4</td>
                                <td>√®</td>
                            </tr>
                            <tr>
                                <td>i</td>
                                <td>1</td>
                                <td>ƒ´</td>
                            </tr>
                            <tr>
                                <td>i</td>
                                <td>2</td>
                                <td>√≠</td>
                            </tr>
                            <tr>
                                <td>i</td>
                                <td>3</td>
                                <td>«ê</td>
                            </tr>
                            <tr>
                                <td>i</td>
                                <td>4</td>
                                <td>√¨</td>
                            </tr>
                            <tr>
                                <td>o</td>
                                <td>1</td>
                                <td>≈ç</td>
                            </tr>
                            <tr>
                                <td>o</td>
                                <td>2</td>
                                <td>√≥</td>
                            </tr>
                            <tr>
                                <td>o</td>
                                <td>3</td>
                                <td>«í</td>
                            </tr>
                            <tr>
                                <td>o</td>
                                <td>4</td>
                                <td>√≤</td>
                            </tr>
                            <tr>
                                <td>u</td>
                                <td>1</td>
                                <td>≈´</td>
                            </tr>
                            <tr>
                                <td>u</td>
                                <td>2</td>
                                <td>√∫</td>
                            </tr>
                            <tr>
                                <td>u</td>
                                <td>3</td>
                                <td>«î</td>
                            </tr>
                            <tr>
                                <td>u</td>
                                <td>4</td>
                                <td>√π</td>
                            </tr>
                            <tr>
                                <td>v</td>
                                <td>1</td>
                                <td>«ñ</td>
                            </tr>
                            <tr>
                                <td>v</td>
                                <td>2</td>
                                <td>«ò</td>
                            </tr>
                            <tr>
                                <td>v</td>
                                <td>3</td>
                                <td>«ö</td>
                            </tr>
                            <tr>
                                <td>v</td>
                                <td>4</td>
                                <td>«ú</td>
                            </tr>
                        </tbody>
                    </table>

                    <p class="text-white">Example: <span class="text-white-50">ni3 hao3</span> will be converted to <span class="text-white-50">n«ê h«éo</span></p>

                    <p class="text-white mt-5">
                        If you like this project, you can <a href="https://www.buymeacoffee.com/consistentcat" target="_blank" class="text-decoration-none text-white-50">buy me a coffee ‚òï</a>. Contact info at <a href="https://zulkiflizin.com" target="_blank" class="text-decoration-none text-white-50">zulkiflizin.com</a> for any feedback or bugs.</p>
                    <p class="text-white-50 text-center mt-5">Version 1.0.0</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
    <script>
        const textArea = document.getElementById("pinyinArea");
        if (localStorage.getItem('pinyin')) {
            textArea.value = localStorage.getItem('pinyin');
            countWords();
        }

        let timeOutId;
        textArea.addEventListener("input", function() {
            clearTimeout(timeOutId); // Clear the timeout if user still typing
            timeOutId = setTimeout(convertInput, 500); // Set a timeout to execute conversion 500ms after user stops typing
        });

        function convertInput() {
            // Split the textarea value into words, convert each word, then rejoin back
            let words = textArea.value.split(' ');
            let pinyinArray = words.map(word => {
                let convertedPinyin = convertToPinyinTone(word); // Assume the function is already defined
                return convertedPinyin;
            });
            textArea.value = pinyinArray.join(' ');
            localStorage.setItem('pinyin', textArea.value);
            countWords();
        }

        function countWords() {
            let wordCount = textArea.value.length > 0 ? textArea.value.split(' ').length : 0;
            let charCount = textArea.value.length;
            document.getElementById("wordCounter").innerHTML = wordCount + " / " + charCount;
        }

        function convertToPinyinTone(pinyinNumbered){
            const toneMap = {
                'a1': 'ƒÅ', 'a2': '√°', 'a3': '«é', 'a4': '√†',
                'e1': 'ƒì', 'e2': '√©', 'e3': 'ƒõ', 'e4': '√®',
                'i1': 'ƒ´', 'i2': '√≠', 'i3': '«ê', 'i4': '√¨',
                'o1': '≈ç', 'o2': '√≥', 'o3': '«í', 'o4': '√≤',
                'u1': '≈´', 'u2': '√∫', 'u3': '«î', 'u4': '√π',
                'v1': '«ñ', 'v2': '«ò', 'v3': '«ö', 'v4': '«ú'
            };

            // Rule 1: Special case handling for "n", "ng", "r".
            pinyinNumbered = pinyinNumbered.replace(/(n|ng|r)([1-4])$/, "$2$1");

            // Rule 2: A tone number following "a", "e", "o" and in "iu", "ui" should be shifted
            pinyinNumbered = pinyinNumbered.replace(/(a|e|o|iu|ui)([1-4])/, "$1$2");

            // Rule 3: Tone number should be placed after first vowel for other cases
            pinyinNumbered = pinyinNumbered.replace(/([aeiou])([a-z]*)([1-4])/, "$1$3$2");

            // Convert to pinyin tone
            Object.keys(toneMap).forEach((k) => {
                const regex = new RegExp(k, 'g');
                pinyinNumbered = pinyinNumbered.replace(regex, toneMap[k]);
            });

            return pinyinNumbered;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                document.exitFullscreen(); 
                }
            }
        }

        function downloadTxt() {
            let text = textArea.value;
            let filename = "pinyin"
            let random = Math.floor(Math.random() * 1000000000);
            filename += random.toString();
            filename += ".txt";
            let blob = new Blob([text], {type: "text/plain;charset=utf-8"});
            saveAs(blob, filename);
        }

        function saveAs(blob, filename) {
            if (window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveBlob(blob, filename);
            } else {
                let a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";
                let url = window.URL.createObjectURL(blob);
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>